---
slug: http-cache
title: http缓存
authors: jonben
tags: [javascript,网络]
---
import { RenderImg } from '@site/src/common'

## 1. 缓存
合理利用缓存是Web性能优化的必要手段，前端工程师所接触的主要是针对客户端浏览器的缓存策略，客户端的缓存可以分为以下两种。
* 利用本地存储，比如`LocalStorage`、`SessionStorage`等。
* 利用**HTTP缓存策略**，其中又分为**强制缓存**与**协商缓存**。

其中对于本地存储的利用属于代码架构层面的优化措施，不属于前端工程体系的服务范畴。HTTP缓存需要服务器配合，比如Apache、Ngnix等服务器软件可以为资源设置不同的HTTP缓存策略。增量更新是目前大部分团队采用的缓存更新方案，结合HTTP强制缓存策略，既能够保证用户在第一时间获取最新资源，又可以减少网络资源消耗，提高Web应用程序的执行速度。

## 2. HTTP缓存策略
浏览器对静态资源的缓存本质上是HTTP协议的缓存策略，其中又可以分为**强制缓存**和**协商缓存**。两种缓存策略都会将资源缓存到本地。具体采用哪种缓存策略，由`HTTP协议`的首部`Headers`信息决定。

* **强制缓存策略**根据过期时间决定使用本地缓存还是请求新资源。
* **协商缓存**每次都会发出请求，经过服务器进行对比后决定采用本地缓存还是新资源。



### 2.1 Expires 和 max-age
`Expires`和`max-age`是强制缓存策略的关键信息，两者均是响应首部信息的。

`Expires`是**HTTP 1.0**加入的特性，通过指定一个明确的时间点作为缓存资源的过期时间，在此时间点之前客户端将使用本地缓存的文件应答请求，而不会向服务器发出实体请求（在浏览器调试面板中可以看到此请求并且状态码为200）。

`Expires`的优点：

可以在缓存过期时间内减少客户端的HTTP请求，不仅节省了客户端处理时间和提高了Web应用的执行速度，而且也减少了服务器负载以及客户端网络资源的消耗。一个典型的`Expires`首部信息如下：

```
Expires:Web, 23 Aug 2017 14:00:00 FMT
```

该信息指定对应资源的缓存过期时间为2017年8月23日14点。

`Expires`有一个致命的缺陷是：

它所指定的时间点是以服务器为准的时间，但是客户端进行过期判断时是将本地的时间与此时间点对比。也就是说，如果客户端的时间与服务器存在误差，比如服务器的时间是`2017年8月23日13点`，而客户端的时间是`2017年8月23日15点`，那么通过上述Expires控制的缓存资源将会失效，客户端将会发送实体请求获取对应资源。这显然是不合理的。

针对这个问题，**HTTP 1.1**新增了`Cache-control`首部信息以便更精准地控制缓存。

常用的`Cache-control`信息有以下几种:

1. `no-cache`和`no-store`：

* `no-cache`并非禁止缓存，而是需要先与服务器确认返回的响应是否发生了变化，如果资源未发生变化，则可使用缓存副本从而避免下载。

* `no-store`是真正意义上的禁止缓存，禁止浏览器以及所有中间缓存存储任何版本的返回响应。每次用户都会向服务器发送请求，并下载完整的响应。
2. `public`和`private`：

* `public`表示此响应可以被浏览器以及中间缓存器无限期缓存，此信息并不常用，常规方案是使用`max-age`指定精确的缓存时间。
* `private`表示此响应可以被用户浏览器缓存，但是不允许任何中间缓存器对其进行缓存。例如，用户的浏览器可以缓存包含用户私人信息的HTML网页，但CDN却不能缓存。
3. `max-age`：
指定从请求的时刻开始计算，此响应的缓存副本有效的最长时间（单位：秒）。例如，`max-age=3600`表示浏览器在接下来的1小时内使用此响应的本地缓存，不会发送实体请求到服务器。
`max-age`指定的是**缓存的时间跨度，而非缓存失效的时间点**，不会受到客户端与服务器时间误差的影响。所以，与`Expires`相比，`max-age`可以更精确地控制缓存，并且比`Expires`**有更高的优先级**。

强制缓存策略下（Cache-control未指定no-cache和no-store）的缓存判断流程如图所示:

<RenderImg
  src={ require('./img/cache1.png') } />
  

### 2.2 Etag 和 If-none-match
```
HTTP/1.1 200 OK
Date: Fri, 30 Oct 1998 13:19:41 GMT
Server: Apache/1.3.3 (Unix)
Cache-Control: max-age=3600, must-revalidate
Expires: Fri, 30 Oct 1998 14:19:41 GMT
Last-Modified: Mon, 29 Jun 1998 02:28:12 GMT
ETag: "3e86-410-3596fbbc"
Content-Length: 1040
Content-Type: text/html
```
`Etag`是**服务器为资源分配的字符串表示形式的唯一性标识**，作为响应首部信息返回给浏览器。浏览器在`Cache-control`指定`no-cache`或者`max-age`和`Expires`均过期之后，将`Etag`值通过`If-none-match`作为请求首部信息发送给服务器。服务器接收到请求之后，对比所请求资源的`Etag`值是否改变，如果未改变将返回`304 Not Modified`，并且根据既定的缓存策略分配新的`Cache-control`信息；如果资源发生了改变，则会返回最新的资源以及重新分配的`Etag`值。整体流程如图所示:

<RenderImg
  src={ require('./img/cache2.png') } />

如果强制浏览器使用`协商缓存策略`，需要将`Cache-control`首部信息设置为`no-cache`，这样便不会判断`max-age`和`Expires`过期时间，从而每次资源请求都会经过服务器对比。

## 3. 总结
`协商缓存`并非是一种比`强制缓存`**低级**的策略，对于一些特殊的应用场景或资源，协商缓存是优于强制缓存的。比如非服务器端渲染项目中的HTML文档，由于它是所有其他静态资源的引用者，所以必须保证每次请求到的资源都是最新的。同时，为了便于服务器解析和保证网站地址的唯一性，html文件不能应用hash指纹。在这种场景下只能使用协商缓存。
